package main

import (
	"context"
	"io"
	"io/ioutil"
	"math"
	"net"
	"os"
	"strings"
	"sync"
	"syscall"
	"testing"
	"time"
	"workspaces/postParser/internal/adapters/driven/rpc"
	"workspaces/postParser/internal/adapters/driven/rpc/pb"
	"workspaces/postParser/internal/logger"
	"workspaces/postParser/internal/repo"

	"github.com/stretchr/testify/suite"
	"google.golang.org/grpc"
)

type mainSuite struct {
	suite.Suite
}

func TestMainSuite(t *testing.T) {
	suite.Run(t, new(mainSuite))
}

var (
	numChan    chan int
	reqChan    chan repo.GRequest
	resChan    chan []repo.GRequest
	sigChan    chan os.Signal
	l          sync.Mutex
	wg         sync.WaitGroup
	baseServer *grpc.Server
	gReqs      []repo.GRequest
	gotLast    int
)

type Server struct {
	pb.PostParserServer
}

func (s *mainSuite) SetupTest() {
	numChan = make(chan int)
	reqChan = make(chan repo.GRequest)
	resChan = make(chan []repo.GRequest, 5)
	sigChan = make(chan os.Signal, 1)

	gotLast = -1
	lis, err := net.Listen("tcp", ":3100")
	if err != nil {
		logger.L.Errorf("in main.SetupTest failed to listen on 3100: %v\n", err)
	}

	baseServer = grpc.NewServer()
	pb.RegisterPostParserServer(baseServer, new(Server))
	go baseServer.Serve(lis)

}

func (s *mainSuite) TestBetterGracefulShutdown() {
	var tMean, tDeviation float64
	dt := make([]time.Duration, 0)
	go main()
	go compose(numChan, reqChan, resChan)

	tt := []struct {
		name                  string
		i                     int
		initialSleep          time.Duration
		postSleep             time.Duration // these sleep variables are used to keep test simple, avoiding concurrency issues and data shuffling
		dialErrorString       string
		req                   []byte
		resB                  []byte
		res                   string
		readFromConnErrString string
		wantGReqs             []repo.GRequest
	}{
		{
			name:         "warmup request",
			i:            0,
			initialSleep: time.Millisecond * 200,
			postSleep:    time.Millisecond * 50,
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"leon\"; filename=\"long.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"0\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"1\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"2\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"3\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"4\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
		},

		{
			name:         "request alone",
			i:            1,
			initialSleep: time.Millisecond * 100,
			postSleep:    time.Millisecond * 50,
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"leon\"; filename=\"long.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"0\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"1\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"2\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"3\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"4\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			res: "HTTP/1.1 200 OK\r\nContent-Length: 6\r\nContent-Type: text/html\r\n\r\n200 OK",
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "leon",
					FileName:  "long.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"0\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"6666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"1\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"77777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"2\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"7777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"77777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"3\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"4\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"77777777777777777777777777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"7777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
			},
			readFromConnErrString: "->127.0.0.1:3000: i/o timeout",
		},

		{
			name: "request with interrupt",
			//initialSleep: time.Millisecond * 200,
			i: 2,
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"leon\"; filename=\"long.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"0\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"1\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"2\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"3\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"4\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			res: "HTTP/1.1 200 OK\r\nContent-Length: 6\r\nContent-Type: text/html\r\n\r\n200 OK",
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "leon",
					FileName:  "long.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"0\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"6666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"1\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"77777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"2\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"7777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"77777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"3\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"4\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"77777777777777777777777777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"7777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
			},
			readFromConnErrString: "->127.0.0.1:3000: i/o timeout",
		},
		{
			name:            "request to stopped server",
			initialSleep:    time.Millisecond * 200,
			i:               3,
			dialErrorString: "dial tcp :3000: connect: connection refused",
		},
	}
	for _, v := range tt {
		s.Run(v.name, func() {
			switch v.i {
			case 0:
				_ = jobFull(s, v.initialSleep, v.postSleep, v.req, v.name, v.res, v.readFromConnErrString, v.wantGReqs, numChan, resChan)
			case 1:
				for i := 0; i < 10; i++ {
					t := jobFull(s, v.initialSleep, v.postSleep, v.req, v.name, v.res, v.readFromConnErrString, v.wantGReqs, numChan, resChan)
					dt = append(dt, t)
				}

				tMean, tDeviation = study(dt)
			case 2:
				logger.L.Infof("in main.TestBetterGracefulShutdown tMean*0.5 = %v\n", tMean*0.5)
				go castSIGINT(tMean * 0.5)
				t := jobFull(s, v.initialSleep, v.postSleep, v.req, v.name, v.res, v.readFromConnErrString, v.wantGReqs, numChan, resChan)
				s.Less(math.Abs(float64(t)-tMean), tDeviation*10)

			case 3:
				time.Sleep(v.initialSleep)
				_, err := net.Dial("tcp", ":3000")
				s.True(strings.Contains(err.Error(), v.dialErrorString))
			}
		})
	}
}

func castSIGINT(t float64) {
	//logger.L.Infoln("main.TestGracefulShutdown sending SIGINT...")
	td := time.Duration(t)
	logger.L.Infof("in main.castSIGINT td %v\n", td)
	timer := time.NewTimer(td)
	t0 := time.Now()
	<-timer.C
	logger.L.Infof("in main.castSIGINT timer fired in %v\n", time.Since(t0))
	p, err := os.FindProcess(os.Getpid())
	if err != nil {
		logger.L.Error(err)
	}
	//logger.L.Infof("trying to send sigint to main")
	p.Signal(syscall.SIGINT)
}

func jobFull(s *mainSuite, initialSleep, postSleep time.Duration, req []byte, name, res, readErrString string, wantGReqs []repo.GRequest, numChan chan int, resChan chan []repo.GRequest) time.Duration {
	var t time.Duration
	resB := make([]byte, 0)

	//logger.L.Infoln("in main.jobFull sleeping")
	time.Sleep(initialSleep)

	//logger.L.Infoln("in main.jobFull dialing")
	conn, err := net.Dial("tcp", ":3000")
	s.NoError(err)

	//logger.L.Infoln("in main.jobFull writing")
	_, err = conn.Write(req)
	t0 := time.Now()
	s.NoError(err)

	if len(wantGReqs) == 0 {
		conn.Close()
		return t
	}
	numChan <- len(wantGReqs)

	//logger.L.Infoln("in main.jobFull reading response")
	conn.SetReadDeadline(time.Now().Add(time.Millisecond * 25))
	resB, err = ioutil.ReadAll(conn)
	if err != nil {
		s.True(strings.Contains(err.Error(), readErrString))
	}
	//logger.L.Infoln("in main.jobFull reciving result")
	result := <-resChan

	t = time.Since(t0)
	//logger.L.Infof("in main.initJob t: %v\n", t)

	s.Equal(res, string(resB))

	s.True(repo.IsOk(name, wantGReqs, result))

	conn.Close()

	time.Sleep(postSleep)

	//logger.L.Infoln("in main.jobFull returning")
	return t
}
func study(durSlice []time.Duration) (float64, float64) {
	var (
		tMean      float64
		tDeviation float64
	)
	for _, v := range durSlice {
		iv := float64(v)
		tMean += iv
	}
	tMean /= float64(len(durSlice))

	for _, v := range durSlice {
		tDeviation += math.Abs(float64(v) - float64(tMean))

	}
	tDeviation /= float64(len(durSlice))

	return tMean, tDeviation
}

func jobBrief(s *mainSuite, name string, req []byte, wantGReqs []repo.GRequest, numChan chan int, resChan chan []repo.GRequest) {

	if len(wantGReqs) == 0 {
		return
	}
	//logger.L.Infoln("in main.jobBrief sleeping")
	initialSleep := math.Max(float64(60*len(wantGReqs)), 200)

	time.Sleep(time.Duration(initialSleep) * time.Millisecond)

	//logger.L.Infoln("in main.jobBrief dialing")
	conn, err := net.Dial("tcp", ":3000")
	s.NoError(err)
	defer conn.Close()

	//logger.L.Infoln("in main.jobBrief writing request")
	_, err = conn.Write(req)
	s.NoError(err)

	n := len(wantGReqs)

	if strings.Contains(name, "last boundary in the end") {
		n++
	}

	//logger.L.Infof("in main.jobBrief sending %d to numChan\n", n)
	numChan <- n

	//logger.L.Infoln("in main.jobBrief waiting for result")
	result := <-resChan
	//logger.L.Infof("in main.jobBrief result len %d\n", len(result))
	s.True(repo.IsOk(name, wantGReqs, result))
}

func (s *mainSuite) TestWorkflow() {

	go main()
	go compose(numChan, reqChan, resChan)

	//time.Sleep(time.Millisecond * 200)

	tt := []struct {
		name      string
		req       []byte
		wantGReqs []repo.GRequest
	}{

		{
			name: "unary 1",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
			},
		},

		{
			name: "unary 2",
			req: []byte(
				"2POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzbz\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
				{
					FieldName: "bob",
					ByteChunk: []byte("bzbzbz"),
				},
			},
		},

		{
			name: "unary 3",
			req: []byte(
				"2POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzbz\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"claire\"\r\n" +
					"\r\n" +
					"czczczcz\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
				{
					FieldName: "claire",
					ByteChunk: []byte("czczczcz"),
				},
				{
					FieldName: "bob",
					ByteChunk: []byte("bzbzbz"),
				},
			},
		},

		{
			name: "unary 7",
			req: []byte(
				"2POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzbz\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"claire\"\r\n" +
					"\r\n" +
					"czczczcz\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"david\"\r\n" +
					"\r\n" +
					"dzdzdzdz\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"erin\"\r\n" +
					"\r\n" +
					"ezezezez\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"frank\"\r\n" +
					"\r\n" +
					"fzfzfzfz\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"grace\"\r\n" +
					"\r\n" +
					"gzgzgzgz\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
				{
					FieldName: "bob",
					ByteChunk: []byte("bzbzbz"),
				},
				{
					FieldName: "claire",
					ByteChunk: []byte("czczczcz"),
				},
				{
					FieldName: "david",
					ByteChunk: []byte("dzdzdzdz"),
				},
				{
					FieldName: "erin",
					ByteChunk: []byte("ezezezez"),
				},
				{
					FieldName: "frank",
					ByteChunk: []byte("fzfzfzfz"),
				},
				{
					FieldName: "grace",
					ByteChunk: []byte("gzgzgzgz"),
				},
			},
		},

		{
			name: "unary short file",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"; filename=\"short.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					FileName:  "short.txt",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"),
				},
			},
		},

		{
			name: "unary short file + unary textfield",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"; filename=\"short.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzbz\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					FileName:  "short.txt",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"),
				},
				{
					FieldName: "bob",
					ByteChunk: []byte("bzbzbz"),
				},
			},
		},

		{
			name: "stream 2 part file",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n"),
				},
				{
					FileData:  true,
					IsLast:    true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n"),
				},
			},
		},
		{
			name: "2 streams 2 part file each",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"matilda\"; filename=\"md_letters.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
					"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
					"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
					"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
					"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\r\n" +
					"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
					"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
					"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
					"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
					"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					IsLast:    true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
				{
					RType:     repo.S,
					FieldName: "matilda",
					FileName:  "md_letters.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "matilda",
					ByteChunk: []byte(
						"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
							"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
							"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
							"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
							"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\r\n" +
							"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					IsLast:    true,
					FieldName: "matilda",
					ByteChunk: []byte(
						"fffffffffffffffffffffffffffffffffffffffff\r\n" +
							"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
							"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
							"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
							"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj"),
				},
			},
		},
		{
			name: "streams 2 part file + 1 unary",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					IsLast:    true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
				{
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
			},
		},
		{
			name: "streams 2 part file + 2 unaries",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzb\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					IsLast:    true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
				{
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},

				{
					FieldName: "bob",
					ByteChunk: []byte("bzbzb"),
				},
			},
		},
		{
			name: "streams 2 part file + 2 unaries, 1 before stream, 1 after stream",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzb\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"5555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
				{
					RType:     repo.U,
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},

				{
					RType:     repo.U,
					FieldName: "bob",
					ByteChunk: []byte("bzbzb"),
				},
			},
		},
		{
			name: "2 2-part streams + 1 unary",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"matilda\"; filename=\"md_letters.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
					"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
					"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
					"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
					"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\r\n" +
					"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
					"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
					"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
					"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
					"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"5555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
				{
					RType:     repo.S,
					FieldName: "matilda",
					FileName:  "letters.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "matilda",
					FileName:  "letters.txt",
					ByteChunk: []byte(
						"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
							"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
							"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
							"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
							"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "matilda",
					FileName:  "letters.txt",
					ByteChunk: []byte(
						"eeeeeee\r\n" +
							"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
							"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
							"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
							"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
							"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj"),
				},
				{
					RType:     repo.U,
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
			},
		},
		{
			name: "1 unary + 2 2-part streams + 1 unary",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"\r\n" +
					"\r\n" +
					"azaza\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"madelyn\"; filename=\"md_digits.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"matilda\"; filename=\"md_letters.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
					"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
					"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
					"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
					"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\r\n" +
					"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
					"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
					"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
					"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
					"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzb\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "madelyn",
					FileName:  "md_digits.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "madelyn",
					ByteChunk: []byte(
						"5555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
				{
					RType:     repo.S,
					FieldName: "matilda",
					FileName:  "letters.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "matilda",
					FileName:  "letters.txt",
					ByteChunk: []byte(
						"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
							"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
							"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
							"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
							"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "matilda",
					FileName:  "letters.txt",
					ByteChunk: []byte(
						"eeeeeee\r\n" +
							"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
							"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
							"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
							"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
							"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj"),
				},
				{
					RType:     repo.U,
					FieldName: "alice",
					ByteChunk: []byte("azaza"),
				},
				{
					RType:     repo.U,
					FieldName: "bob",
					ByteChunk: []byte("bzbzb"),
				},
			},
		},
		{
			name: "1 5-part stream",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"leon\"; filename=\"long.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"0\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"1\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"2\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"3\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"4\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "leon",
					FileName:  "long.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"0\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"6666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"1\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"77777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"2\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"7777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"77777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"3\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
							"4\r\n" +
							"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"77777777777777777777777777777777777777"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "leon",
					FileName:  "long.txt",
					ByteChunk: []byte(
						"7777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
			},
		},
		{
			name: "stream part of last boundary in the end",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"; filename=\"short.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					FieldName: "alice",
					FileName:  "short.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					FileData:  true,
					FieldName: "alice",
					FileName:  "short.txt",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n"),
				},
			},
		},
		{
			name: "stream + unary. Edged boundary",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"; filename=\"short.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"\r\n" +
					"\r\n" +
					"bzbzbz\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "alice",
					FileName:  "short.txt",
					FileInfo:  true,
					IsFirst:   true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "alice",
					FileName:  "short.txt",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.U,
					FieldName: "bob",
					ByteChunk: []byte("bzbzbz"),
				},
			},
		},
		{
			name: "2 streams; intermediate boundary between them",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"; filename=\"file1.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"bob\"; filename=\"file2.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
					"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
					"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
					"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
					"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\r\n" +
					"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
					"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
					"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
					"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii\r\n" +
					"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "alice",
					FileName:  "file1.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "alice",
					FileName:  "file1.txt",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FieldName: "bob",
					FileName:  "file2.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "bob",
					FileName:  "file2.txt",
					ByteChunk: []byte(
						"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n" +
							"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\r\n" +
							"ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\n" +
							"ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\r\n" +
							"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\r\n" +
							"fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\r\n" +
							"ggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg\r\n" +
							"hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh\r\n" +
							"iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "bob",
					FileName:  "file2.txt",
					ByteChunk: []byte(
						"iiiiiiiiiiii\r\n" +
							"jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj"),
				},
			},
		},
		{
			name: "1 stream; boundary part means nothing",
			req: []byte(
				"POST / HTTP/1.1\r\n" +
					"Host: localhost\r\n" +
					"User-Agent: curl/7.75.0\r\n" +
					"Accept: */*\r\n" +
					"Content-Length: 5250\r\n" +
					"Content-Type: multipart/form-data; boundary=------------------------c61fd8e07a9d3f9b\r\n" +
					"\r\n" +
					"--------------------------c61fd8e07a9d3f9b\r\n" +
					"Content-Disposition: form-data; name=\"alice\"; filename=\"fake_boundary.txt\"\r\n" +
					"Content-Type: text/plain\r\n" +
					"\r\n" +
					"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
					"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
					"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
					"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
					"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
					"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
					"66666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"----------------------\r\n" +
					"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
					"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
					"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
					"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999\r\n" +
					"--------------------------c61fd8e07a9d3f9b--\r\n"),
			wantGReqs: []repo.GRequest{
				{
					RType:     repo.S,
					FieldName: "alice",
					FileName:  "fake_boundary.txt",
					FileInfo:  true,
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "alice",
					FileName:  "fake_boundary.txt",
					ByteChunk: []byte(
						"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n" +
							"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\n" +
							"222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\r\n" +
							"333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\r\n" +
							"444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444\r\n" +
							"555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555\r\n" +
							"66666666666666666666666666666666666666666666666666666666666666666666"),
				},
				{
					RType:     repo.S,
					FileData:  true,
					FieldName: "alice",
					FileName:  "fake_boundary.txt",
					ByteChunk: []byte(
						"\r\n----------------------\r\n" +
							"6666666666666666666666666666666666666666666666666666666666666666666666666666666666666\r\n" +
							"777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777\r\n" +
							"888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888\r\n" +
							"999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"),
				},
			},
		},
	}

	for _, v := range tt {
		s.Run(v.name, func() {
			jobBrief(s, v.name, v.req, v.wantGReqs, numChan, resChan)
		})

	}

}

// time.Millisecond * 200

func (s *Server) SinglePart(ctx context.Context, in *pb.TextFieldReq) (*pb.TextFieldRes, error) {
	//logger.L.Infof("in main.SinglePart received %v\n", in)
	resToChan := rpc.DecodeUnaryReq(in)

	resToReturn := &pb.TextFieldRes{Result: true}
	reqChan <- resToChan
	return resToReturn, nil
}

func (s *Server) MultiPart(stream pb.PostParser_MultiPartServer) error {
	n := 0
	reqInfo, err := stream.Recv()
	if err != nil {
		return err
	}
	//	l.Lock()

	reqInfoToChan := rpc.DecodeStreamInfoReq(reqInfo)
	//logger.L.Infof("in main.MultiPart initial req %v, decoded %v\n", reqInfo, reqInfoToChan)
	reqChan <- reqInfoToChan

	for {
		/*
			if n > 0 {
				l.Lock()
			}
		*/
		reqData, err := stream.Recv()

		if err == io.EOF {
			//logger.L.Info("stream was closed by client")
			break
		}

		if err != nil {
			logger.L.Error(err)
			return err
		}

		resDataToChan := rpc.DecodeStreamDataReq(reqData, reqInfo.GetFileInfo())
		//logger.L.Infof("in main.MultiPart for looped req %v\n", reqData)
		reqChan <- resDataToChan
		//	l.Unlock()
		n++
	}

	res := &pb.FileUploadRes{
		FileName: "filename",
		FileSize: uint32(100),
	}

	err = stream.SendAndClose(res)
	if err != nil {
		return err
	}

	return nil
}

func feedback(reqChan chan repo.GRequest, gReqs *[]repo.GRequest) {
	old, new, lastSaved, n, m := make([]repo.GRequest, 0), make([]repo.GRequest, 0), false, 0, 0

	for r := range reqChan {
		l.Lock()

		if r.FieldName == "" {
			lastSaved = false
			n = 0
			m++
			l.Unlock()
			continue
		}

		nm := n == 0 && m == 1

		logger.L.Infof("in main.feedback req fieldName: %q, fileName: %q, byteChunk: %q, first? %t, last? %t, fileInfo? %t, fileData? %v, RType %d, len(gRecs) = %d, nm = %t\n", r.FieldName, r.FileName, r.ByteChunk, r.IsFirst, r.IsLast, r.FileInfo, r.FileData, r.RType, len(*gReqs), nm)
		n++
		old = *gReqs
		if r.RType == repo.U && r.IsLast {
			lastSaved = true
		}
		if r.RType == repo.U && r.IsFirst && len(old) > 0 { // First one delayed in transferring, should put it to 0 - index
			new = append(make([]repo.GRequest, 0), r)
			*gReqs = append(new, *gReqs...)
			l.Unlock()
			logger.L.Infof("in main.feedback len(gReqs) became %d\n", len(*gReqs))
			continue
		}
		if r.RType == repo.U && lastSaved && !r.IsLast { // Last one came too early, should swap it with last unit
			for i, v := range *gReqs {
				if v.IsLast {
					buf := (*gReqs)[i]
					(*gReqs)[i] = r
					*gReqs = append(*gReqs, buf)
					break
				}
			}
			l.Unlock()
			logger.L.Infof("in main.feedback len(gReqs) became %d\n", len(*gReqs))
			continue
		}
		if r.RType == repo.S && r.IsLast {
			lastSaved = true
			if len(r.ByteChunk) == 0 && len(old) > 0 { // setting isLast by separate request

				len := len(*gReqs)
				(*gReqs)[len-1].IsLast = true

				l.Unlock()
				logger.L.Infof("in main.feedback len(gReqs) became %d\n", len)
				continue

			}
		}

		if r.RType == repo.S && r.IsFirst && len(old) > 0 {

			//logger.L.Infof("in main.TestMain during first stage swapping old = %v\n", old)
			new = append(make([]repo.GRequest, 0), r)
			//gReqs = append(make([]repo.GRequest, 0), r)

			//logger.L.Infof("in main.TestMain during first stage swapping gReqs = %v\n", gReqs)
			l.Unlock()
			logger.L.Infof("in main.feedback len(gReqs) became %d\n", len(*gReqs))
			continue
			//gReqs = append(make([]repo.GRequest, 0), old...)
		}
		if r.RType == repo.S && r.FileData && len(new) == 1 && len(old) > 0 {
			new = append(new, r)
			/*
				new = append(new, old...)
			*/
			*gReqs = make([]repo.GRequest, 0)
			*gReqs = append(*gReqs, new...)
			*gReqs = append(*gReqs, old...)
			//old = make([]repo.GRequest, 0)
			l.Unlock()
			logger.L.Infof("in main.feedback len(gReqs) became %d\n", len(*gReqs))
			continue
			//	gReqs = append(gReqs, r)
			//	gReqs = append(gReqs, old...)
			//logger.L.Infof("in main.TestMain after second stage swapping gReqs = %v\n", gReqs)

		}
		if r.RType == repo.S && lastSaved && !r.IsLast {
			for i, v := range *gReqs {
				if v.IsLast {
					buf := (*gReqs)[i]
					(*gReqs)[i] = r
					*gReqs = append(*gReqs, buf)
					break
				}
			}
			l.Unlock()
			logger.L.Infof("in main.feedback len(gReqs) became %d\n", len(*gReqs))
			continue
		}
		/*if r.RType == repo.S && len(r.ByteChunk) == 0 && r.IsLast && len(old) > 0 {
			//gReqs[len(gReqs)-1].IsLast = true
			len := len(*gReqs)
			(*gReqs)[len-1].IsLast = true
			l.Unlock()

			logger.L.Infof("in main.feedback len(gReqs) became %d\n", len)
			continue
		}
		*/
		*gReqs = append(*gReqs, r)
		//logger.L.Infof("in main.feedback after ptr = %v", gReqs)
		l.Unlock()
		logger.L.Infof("in main.feedback len(gReqs) became %d\n", len(*gReqs))
	}
}

func compose(numChan chan int, reqChan chan repo.GRequest, resChan chan []repo.GRequest) {

	for n := range numChan {
		res := make([]repo.GRequest, 0)
		//logger.L.Infof("main.compose from numChan got %d\n", n)
		//t0 := time.Now()
		for j := 0; j < n; j++ {
			//logger.L.Infof("main.compose j %d\n", j)
			//logger.L.Infof("in main.compose waiting for req from reqChan len = %d\n", len(reqChan))
			r := <-reqChan
			//logger.L.Warnf("in main.compose r: {fieldName: %q, fileName: %q, byteChunk %q, isFirst %t, isLast %t}\n", r.FieldName, r.FileName, r.ByteChunk, r.IsFirst, r.IsLast)
			res = add(res, r)
		}
		//logger.L.Infof("in main.compose took %v time\n", float64(time.Since(t0)))
		/*
			for i, v := range res {
				logger.L.Infof("in main.compose res i = %d, v.ByteChunk: %q\n", i, v.ByteChunk)
			}
		*/
		gotLast = -1
		resChan <- res

	}
}

func add(res []repo.GRequest, r repo.GRequest) []repo.GRequest {

	switch {
	case r.IsFirst && len(res) > 0:

		old := res
		res = make([]repo.GRequest, 0)
		res = append(res, r)
		res = append(res, old...)

	case r.IsLast && len(r.ByteChunk) == 0 && len(res) > 0:

		res[len(res)-1].IsLast = true

	case r.IsLast && gotLast < 0:

		//logger.L.Warnf("main.fixGRPCIssues received last request %v\n", r)
		gotLast = len(res)
		//logger.L.Warnf("main.fixGRPCIssues gotLast = %d\n", gotLast)
		res = append(res, r)
		//logger.L.Warnf("main.fixGRPCIssues res = %v\n", res)

	case gotLast > 0 && !r.IsLast:

		//logger.L.Errorf("main.fixGRPCIssues from reqChan after last received %v\n", r)
		old := res[gotLast]
		res[gotLast] = r
		gotLast = len(res)
		res = append(res, old)

		//logger.L.Warnf("main.fixGRPCIssues res = %v\n", res)

	default:
		res = append(res, r)
	}
	return res
}
